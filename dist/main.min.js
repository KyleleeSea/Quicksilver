"use strict";const showWatermark=0,godMode=0,debug=0,PI=Math.PI,abs=e=>e<0?-e:e,min=(e,t)=>e<t?e:t,max=(e,t)=>e>t?e:t,sign=e=>e<0?-1:1,mod=(e,t=1)=>(e%t+t)%t,clamp=(e,t=0,i=1)=>e<t?t:e>i?i:e,percent=(e,t=0,i=1)=>i-t?clamp((e-t)/(i-t)):0,lerp=(e,t=0,i=1)=>t+clamp(e)*(i-t),smoothStep=e=>e*e*(3-2*e),nearestPowerOfTwo=e=>2**Math.ceil(Math.log2(e)),isOverlapping=(e,t,i,s)=>2*abs(e.x-i.x)<t.x+s.x&2*abs(e.y-i.y)<t.y+s.y,wave=(e=1,t=1,i=time)=>t/2*(1-Math.cos(i*e*2*PI)),rand=(e=1,t=0)=>t+(e-t)*Math.random(),randInt=(e=1,t=0)=>0|rand(e,t),randSign=()=>2*(0|rand(2))-1,randInCircle=(e=1,t=0)=>e>0?randVector(e*rand(t/e,1)**.5):new Vector2,randVector=(e=1)=>(new Vector2).t(rand(2*PI),e),randColor=(e=new Color,t=new Color(0,0,0,1),i)=>i?e.i(t,rand()):new Color(rand(e.r,t.r),rand(e.g,t.g),rand(e.b,t.b),rand(e.a,t.a));let randSeed=1;const vec2=(e=0,t)=>null==e.x?new Vector2(e,null==t?e:t):new Vector2(e.x,e.y);class Vector2{constructor(e=0,t=0){this.x=e,this.y=t}o(){return new Vector2(this.x,this.y)}add(e){return new Vector2(this.x+e.x,this.y+e.y)}l(e){return new Vector2(this.x-e.x,this.y-e.y)}multiply(e){return new Vector2(this.x*e.x,this.y*e.y)}h(e){return new Vector2(this.x/e.x,this.y/e.y)}scale(e){return new Vector2(this.x*e,this.y*e)}length(){return this.u()**.5}u(){return this.x**2+this.y**2}m(e){return this.p(e)**.5}p(e){return(this.x-e.x)**2+(this.y-e.y)**2}normalize(e=1){const t=this.length();return t?this.scale(e/t):new Vector2(0,e)}v(e=1){const t=this.length();return t>e?this.scale(e/t):this}S(e){return this.x*e.x+this.y*e.y}angle(){return Math.atan2(this.x,this.y)}t(e=0,t=1){return this.x=t*Math.sin(e),this.y=t*Math.cos(e),this}rotate(e){const t=Math.cos(e),i=Math.sin(e);return new Vector2(this.x*t-this.y*i,this.x*i+this.y*t)}direction(){return abs(this.x)>abs(this.y)?this.x<0?3:1:this.y<0?2:0}T(){return new Vector2(this.y,-this.x)}floor(){return new Vector2(Math.floor(this.x),Math.floor(this.y))}C(){return abs(this.x*this.y)}i(e,t){return this.add(e.l(this).scale(clamp(t)))}P(e){return this.x>=0&&this.y>=0&&this.x<e.x&&this.y<e.y}}class Color{constructor(e=1,t=1,i=1,s=1){this.r=e,this.g=t,this.b=i,this.a=s}o(){return new Color(this.r,this.g,this.b,this.a)}add(e){return new Color(this.r+e.r,this.g+e.g,this.b+e.b,this.a+e.a)}l(e){return new Color(this.r-e.r,this.g-e.g,this.b-e.b,this.a-e.a)}scale(e,t=e){return new Color(this.r*e,this.g*e,this.b*e,this.a*t)}i(e,t){return this.add(e.l(this).scale(clamp(t)))}toString(){return`rgb(${255*this.r|0},${255*this.g|0},${255*this.b|0},${this.a})`}D(){return(255*this.r|0)+(255*this.g<<8)+(255*this.b<<16)+(255*this.a<<24)}I(){const e=e=>((e=255*e|0)<16?"0":"")+e.toString(16);return"#"+e(this.r)+e(this.g)+e(this.b)}}class Timer{constructor(e){this.time=null==e?void 0:time+e,this.setTime=e}set(e=0){this.time=time+e,this.setTime=e}M(){this.time=void 0}F(){return null!=this.time}active(){return time<=this.time}B(){return time>this.time}get(){return this.F()?time-this.time:0}}let canvasMaxSize=vec2(1920,1200),canvasFixedSize=vec2();const cavasPixelated=1;let fontDefault="arial",tileSizeDefault=vec2(16),tileFixBleedScale=.3,objectDefaultSize=vec2(1),enablePhysicsSolver=1,objectDefaultMass=1,objectDefaultDamping=.99,objectDefaultAngleDamping=.99,objectDefaultElasticity=0,objectDefaultFriction=.8,objectMaxSpeed=1,gravity=0,particleEmitRateScale=1,cameraPos=vec2(),cameraScale=max(tileSizeDefault.x,tileSizeDefault.y);const glEnable=0,glOverlay=0,gamepadsEnable=0,gamepadDirectionEmulateStick=0;let inputWASDEmulateDirection=1,touchGamepadEnable=0,touchGamepadAnalog=0,touchGamepadSize=80,touchGamepadAlpha=.3;const vibrateEnable=0;let soundVolume=.5;const soundEnable=1,soundDefaultRange=30;let soundDefaultTaper=.7;const engineName="LittleJS",engineVersion="1.3.8",frameRate=60,timeDelta=1/60;let engineObjects=[],engineObjectsCollide=[],frame=0,time=0,timeReal=0;const paused=0;let tileImageSize,tileImageFixBleed,averageFPS,drawCount,frameTimeLastMS=0,frameTimeBufferMS=0;const styleBody="margin:0;overflow:hidden;background:#000;touch-action:none;user-select:none;-webkit-user-select:none;-moz-user-select:none",styleCanvas="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%)";function engineInit(e,t,i,s,a,o){tileImage.onerror=tileImage.onload=()=>{tileImageFixBleed=vec2(tileFixBleedScale).h(tileImageSize=vec2(tileImage.width,tileImage.height)),document.body.style=styleBody,document.body.appendChild(mainCanvas=document.createElement("canvas")),mainContext=mainCanvas.getContext("2d"),mainCanvas.style=styleCanvas,document.body.appendChild(overlayCanvas=document.createElement("canvas")),overlayContext=overlayCanvas.getContext("2d"),overlayCanvas.style=styleCanvas,e(),n()};const n=(e=0)=>{let o=e-frameTimeLastMS;frameTimeLastMS=e,frameTimeBufferMS=min(frameTimeBufferMS+!0*o,50),overlayCanvas.width=mainCanvas.width=min(innerWidth,canvasMaxSize.x),overlayCanvas.height=mainCanvas.height=min(innerHeight,canvasMaxSize.y),mainCanvasSize=vec2(mainCanvas.width,mainCanvas.height);let r=0;for(frameTimeBufferMS<0&&frameTimeBufferMS>-9&&(r=frameTimeBufferMS,frameTimeBufferMS=0);frameTimeBufferMS>=0;frameTimeBufferMS-=1e3/60)inputUpdate(),t(),engineObjectsUpdate(),i(),inputUpdatePost();frameTimeBufferMS+=r,enginePreRender(),s(),engineObjects.sort((e,t)=>e.L-t.L);for(const e of engineObjects)e.G||e.k();a(),requestAnimationFrame(n)};o?tileImage.src=o:tileImage.onload()}function enginePreRender(){mainCanvasSize=vec2(mainCanvas.width,mainCanvas.height),mainContext.imageSmoothingEnabled=!1}function engineObjectsUpdate(){engineObjectsCollide=engineObjects.filter(e=>e.R);const e=t=>{if(!t.G){t.update();for(const i of t.children)e(i)}};for(const t of engineObjects)t.parent||e(t);engineObjects=engineObjects.filter(e=>!e.G),time=++frame/60}function engineObjectsDestroy(){for(const e of engineObjects)e.parent||e.destroy();engineObjects=engineObjects.filter(e=>!e.G)}function engineObjectsCallback(e,t,i,s=engineObjects){if(e)if(null!=t.x)for(const a of s)isOverlapping(e,t,a.j,a.size)&&i(a);else{const a=t*t;for(const t of s)e.p(t.j)<a&&i(t)}else for(const e of s)i(e)}class EngineObject{constructor(e=vec2(),t=objectDefaultSize,i=-1,s=tileSizeDefault,a=0,o,n=0){this.j=e.o(),this.size=t,this.O,this.A=i,this._=s,this.angle=a,this.color=o,this.X,this.N=objectDefaultMass,this.U=objectDefaultDamping,this.W=objectDefaultAngleDamping,this.V=objectDefaultElasticity,this.K=objectDefaultFriction,this.Y=1,this.L=n,this.H=new Vector2,this.$=0,this.J=time,this.children=[],this.q=1,engineObjects.push(this)}update(){const e=this.parent;if(e)return this.j=this.Z.multiply(vec2(e.ee(),1)).rotate(-e.angle).add(e.j),void(this.angle=e.ee()*this.te+e.angle);this.H.x=clamp(this.H.x,-objectMaxSpeed,objectMaxSpeed),this.H.y=clamp(this.H.y,-objectMaxSpeed,objectMaxSpeed);const t=this.j.o();if(this.j.x+=this.H.x=this.U*this.H.x,this.j.y+=this.H.y=this.U*this.H.y+gravity*this.Y,this.angle+=this.$*=this.W,!enablePhysicsSolver||!this.N)return;const i=this.H.y<0;if(this.ie){const e=this.ie.H?this.ie.H.x:0;this.H.x=e+(this.H.x-e)*this.K,this.ie=0}if(this.R){const e=.001;for(const s of engineObjectsCollide){if(!this.se&!s.se||s.G||s.parent||s==this)continue;if(!isOverlapping(this.j,this.size,s.j,s.size))continue;if(!this.ae(s)|!s.ae(this))continue;if(isOverlapping(t,this.size,s.j,s.size)){const e=t.l(s.j),i=e.length(),a=.001,o=i<.01?randVector(a):e.scale(a/i);this.H=this.H.add(o),s.N&&(s.H=s.H.l(o));continue}const a=this.size.add(s.size),o=2*(t.y-s.j.y)>a.y+gravity,n=2*abs(t.y-s.j.y)<a.y,r=2*abs(t.x-s.j.x)<a.x;if(o||r||!n)if(this.j.y=s.j.y+(a.y/2+e)*sign(t.y-s.j.y),s.ie&&i||!s.N)i&&(this.ie=s),this.H.y*=-this.V;else if(s.N){const e=(this.N*this.H.y+s.N*s.H.y)/(this.N+s.N),t=this.H.y*(this.N-s.N)/(this.N+s.N)+2*s.H.y*s.N/(this.N+s.N),i=s.H.y*(s.N-this.N)/(this.N+s.N)+2*this.H.y*this.N/(this.N+s.N),a=max(this.V,s.V);this.H.y=lerp(a,e,t),s.H.y=lerp(a,e,i)}if(!o&&(n||!r))if(this.j.x=s.j.x+(a.x/2+e)*sign(t.x-s.j.x),s.N){const e=(this.N*this.H.x+s.N*s.H.x)/(this.N+s.N),t=this.H.x*(this.N-s.N)/(this.N+s.N)+2*s.H.x*s.N/(this.N+s.N),i=s.H.x*(s.N-this.N)/(this.N+s.N)+2*this.H.x*this.N/(this.N+s.N),a=max(this.V,s.V);this.H.x=lerp(a,e,t),s.H.x=lerp(a,e,i)}else this.H.x*=-this.V}}if(this.q&&tileCollisionTest(this.j,this.size,this)&&!tileCollisionTest(t,this.size,this)){const e=tileCollisionTest(new Vector2(t.x,this.j.y),this.size,this),s=tileCollisionTest(new Vector2(this.j.x,t.y),this.size,this);if(e||!s){this.ie=i,this.H.y*=-this.V;const e=(t.y-this.size.y/2|0)-(t.y-this.size.y/2);e<0&&e>this.U*this.H.y+gravity*this.Y&&(this.H.y=this.U?(e-gravity*this.Y)/this.U:0),this.j.y=t.y}s&&(this.j.x=t.x,this.H.x*=-this.V)}}k(){drawTile(this.j,this.O||this.size,this.A,this._,this.color,this.angle,this.oe,this.X)}destroy(){if(!this.G){this.G=1,this.parent&&this.parent.removeChild(this);for(const e of this.children)e.destroy(e.parent=0)}}ne(e,t){return e>0}re(e,t){return e>0}ae(e){return 1}le(){return time-this.J}ce(e){this.N&&(this.H=this.H.add(e))}he(e){this.ce(e.scale(1/this.N))}ee(){return this.oe?-1:1}ue(e=0,t=0,i=1){this.R=e,this.se=t,this.q=i}toString(){let e="type = "+this.constructor.name;return(this.j.x||this.j.y)&&(e+="\npos = "+this.j),(this.H.x||this.H.y)&&(e+="\nvelocity = "+this.H),(this.size.x||this.size.y)&&(e+="\nsize = "+this.size),this.angle&&(e+="\nangle = "+this.angle.toFixed(3)),this.color&&(e+="\ncolor = "+this.color),e}}const tileImage=new Image;let mainCanvas,mainContext,overlayCanvas,overlayContext,mainCanvasSize=vec2();const screenToWorld=e=>e.add(vec2(.5)).l(mainCanvasSize.scale(.5)).multiply(vec2(1/cameraScale,-1/cameraScale)).add(cameraPos),worldToScreen=e=>e.l(cameraPos).multiply(vec2(cameraScale,-cameraScale)).add(mainCanvasSize.scale(.5)).l(vec2(.5));function drawTile(e,t=vec2(1),i=-1,s=tileSizeDefault,a=new Color,o=0,n,r=new Color(0,0,0,0),l=0){drawCanvas2D(e,t,o,n,e=>{if(i<0)e.fillStyle=a,e.fillRect(-.5,-.5,1,1);else{const t=tileImageSize.x/s.x|0,o=i%t*s.x+tileFixBleedScale,n=(i/t|0)*s.y+tileFixBleedScale,r=s.x-2*tileFixBleedScale,l=s.y-2*tileFixBleedScale;e.globalAlpha=a.a,e.drawImage(tileImage,o,n,r,l,-.5,-.5,1,1)}})}function drawRect(e,t,i,s,a){drawTile(e,t,-1,tileSizeDefault,i,s,0,0,a)}function drawLine(e,t,i=.1,s,a=0){const o=vec2((t.x-e.x)/2,(t.y-e.y)/2),n=vec2(i,2*o.length());drawRect(e.add(o),n,s,o.angle(),a)}function drawCanvas2D(e,t,i,s,a,o=mainContext){e=worldToScreen(e),t=t.scale(cameraScale),o.save(),o.translate(e.x+.5|0,e.y+.5|0),o.rotate(i),o.scale(s?-t.x:t.x,t.y),a(o),o.restore()}function setBlendMode(e,t=0){mainContext.globalCompositeOperation=e?"lighter":"source-over"}function drawTextScreen(e,t,i=1,s=new Color,a=0,o=new Color(0,0,0),n="center",r=fontDefault){overlayContext.fillStyle=s,overlayContext.lineWidth=a,overlayContext.strokeStyle=o,overlayContext.textAlign=n,overlayContext.font=i+"px "+r,overlayContext.textBaseline="middle",overlayContext.lineJoin="round",t=t.o(),(e+"").split("\n").forEach(e=>{a&&overlayContext.strokeText(e,t.x,t.y),overlayContext.fillText(e,t.x,t.y),t.y+=i})}function drawText(e,t,i=1,s,a,o,n,r){drawTextScreen(e,worldToScreen(t),i*cameraScale,s,a*cameraScale,o,n,r)}const isFullscreen=()=>document.fullscreenElement;function toggleFullscreen(){isFullscreen()?document.exitFullscreen?document.exitFullscreen():document.mozCancelFullScreen&&document.mozCancelFullScreen():document.body.webkitRequestFullScreen?document.body.webkitRequestFullScreen():document.body.mozRequestFullScreen&&document.body.mozRequestFullScreen()}const keyIsDown=(e,t=0)=>inputData[t]&&1&inputData[t][e]?1:0,keyWasPressed=(e,t=0)=>inputData[t]&&2&inputData[t][e]?1:0,keyWasReleased=(e,t=0)=>inputData[t]&&4&inputData[t][e]?1:0,clearInput=()=>inputData=[[]],mouseIsDown=keyIsDown,mouseWasPressed=keyWasPressed,mouseWasReleased=keyWasReleased;let mousePos=vec2(),mousePosScreen=vec2(),mouseWheel=0,isUsingGamepad=0,preventDefaultInput=0,inputData=[[]];function inputUpdate(){document.hasFocus()||clearInput(),mousePos=screenToWorld(mousePosScreen)}function inputUpdatePost(){for(const e of inputData)for(const t in e)e[t]&=1;mouseWheel=0}onkeydown=e=>{e.repeat||(inputData[isUsingGamepad=0][remapKeyCode(e.keyCode)]=3),preventDefaultInput&&e.preventDefault()},onkeyup=e=>{inputData[0][remapKeyCode(e.keyCode)]=4};const remapKeyCode=e=>inputWASDEmulateDirection?87==e?38:83==e?40:65==e?37:68==e?39:e:e;onmousedown=e=>{inputData[isUsingGamepad=0][e.button]=3,onmousemove(e),e.button&&e.preventDefault()},onmouseup=e=>inputData[0][e.button]=2&inputData[0][e.button]|4,onmousemove=e=>mousePosScreen=mouseToScreen(e),onwheel=e=>e.ctrlKey||(mouseWheel=sign(e.deltaY)),oncontextmenu=e=>!1;const mouseToScreen=e=>{if(!mainCanvas)return vec2();const t=mainCanvas.getBoundingClientRect();return vec2(mainCanvas.width,mainCanvas.height).multiply(vec2(percent(e.x,t.left,t.right),percent(e.y,t.top,t.bottom)))},isTouchDevice=void 0!==window.ontouchstart;if(isTouchDevice){let e,t;ontouchstart=ontouchmove=ontouchend=i=>{i.button=0;const s=i.touches.length;return s?(t||zzfx(0,t=1),i.x=i.touches[0].clientX,i.y=i.touches[0].clientY,e?onmousemove(i):onmousedown(i)):e&&onmouseup(i),e=s,!i.cancelable}}class Sound{constructor(e,t=30,i=soundDefaultTaper){this.range=t,this.de=i,this.me=e[1]||0,e[1]=0,this.fe=zzfxG(...e)}play(e,t=1,i=1,s=1){let a=0;if(e){const i=this.range;if(i){const s=cameraPos.p(e);if(s>i*i)return;t*=percent(s**.5,i,i*this.de)}a=2*worldToScreen(e).x/mainCanvas.width-1}const o=i+i*this.me*s*rand(-1,1);return playSamples([this.fe],t,o,a)}pe(e,t,i=1){return this.play(t,i,2**(e/12),0)}}class Music{constructor(e){this.fe=zzfxM(...e)}play(e=1,t=1){return this.source=playSamples(this.fe,e,1,0,t),this.source}ve(e){this.source&&this.source.Se&&(this.source.Se.gain.value=soundVolume*e)}}const getNoteFrequency=(e,t=220)=>t*2**(e/12);let audioContext;function playSamples(e,t=1,i=1,s=0,a=0){audioContext||(audioContext=new(window.AudioContext||webkitAudioContext)),audioContext.resume();const o=audioContext.createBuffer(e.length,e[0].length,zzfxR),n=audioContext.createBufferSource();e.forEach((e,t)=>o.getChannelData(t).set(e)),n.buffer=o,n.playbackRate.value=i,n.loop=a;const r=audioContext.createGain();return r.gain.value=soundVolume*t,r.connect(audioContext.destination),(window.StereoPannerNode?n.connect(new StereoPannerNode(audioContext,{pan:clamp(s,-1,1)})):n).connect(r),n.start(),n.Se=r,n}const zzfx=(...e)=>playSamples([zzfxG(...e)]),zzfxR=44100;function zzfxG(e=1,t=.05,i=220,s=0,a=0,o=.1,n=0,r=1,l=0,c=0,h=0,u=0,d=0,m=0,f=0,p=0,v=0,S=1,g=0,T=0){let C,y,w=2*PI,P=l*=500*w/zzfxR/zzfxR,b=[],D=i*=(1+t*rand(-1,1))*w/zzfxR,I=0,x=0,z=0,M=1,E=0,F=0,B=0;for(c*=500*w/zzfxR**3,f*=w/zzfxR,h*=w/zzfxR,u*=zzfxR,d=d*zzfxR|0,y=(s=s*zzfxR+9)+(g*=zzfxR)+(a*=zzfxR)+(o*=zzfxR)+(v*=zzfxR)|0;z<y;b[z++]=B)++F%(100*p|0)||(B=n?n>1?n>2?n>3?Math.sin((I%w)**3):max(min(Math.tan(I),1),-1):1-(2*I/w%2+2)%2:1-4*abs(Math.round(I/w)-I/w):Math.sin(I),B=(d?1-T+T*Math.sin(w*z/d):1)*sign(B)*abs(B)**r*e*soundVolume*(z<s?z/s:z<s+g?1-(z-s)/g*(1-S):z<s+g+a?S:z<y-v?(y-z-v)/o*S:0),B=v?B/2+(v>z?0:(z<y-v?1:(y-z)/v)*b[z-v|0]/2):B),C=(i+=l+=c)*Math.cos(f*x++),I+=C-C*m*(1-1e9*(Math.sin(z)+1)%2),M&&++M>u&&(i+=h,D+=h,M=0),!d||++E%d||(i=D,l=P,M=M||1);return b}function zzfxM(e,t,i,s=125){let a,o,n,r,l,c,h,u,d,m,f,p,v,S,g=0,T=[],C=[],y=[],w=0,P=0,b=1,D={},I=zzfxR/s*60>>2;for(;b;w++)T=[b=u=p=0],i.forEach((s,x)=>{for(h=t[s][w]||[0,0,0],b|=!!t[s][w],S=p+(t[s][0].length-2-!u)*I,v=x==i.length-1,o=2,r=p;o<h.length+v;u=++o){for(l=h[o],d=o==h.length+v-1&&v||m!=(h[0]||0)|l|0,n=0;n<I&&u;n++>I-99&&d?f+=(f<1)/99:0)c=(1-f)*T[g++]/2||0,C[r]=(C[r]||0)-c*P+c,y[r]=(y[r++]||0)+c*P+c;l&&(f=l%1,P=h[1]||0,(l|=0)&&(T=D[[m=h[g=0]||0,l]]=D[[m,l]]||(a=[...e[m]],a[2]*=2**((l-12)/12),l>0?zzfxG(...a):[])))}p=S});return[C,y]}let tileCollision=[],tileCollisionSize=vec2();function initTileCollision(e){tileCollisionSize=e,tileCollision=[];for(let e=tileCollision.length=tileCollisionSize.C();e--;)tileCollision[e]=0}const setTileCollisionData=(e,t=0)=>e.P(tileCollisionSize)&&(tileCollision[(0|e.y)*tileCollisionSize.x+e.x|0]=t),getTileCollisionData=e=>e.P(tileCollisionSize)?tileCollision[(0|e.y)*tileCollisionSize.x+e.x|0]:0;function tileCollisionTest(e,t=vec2(),i){const s=max(e.x-t.x/2|0,0),a=max(e.y-t.y/2|0,0),o=min(e.x+t.x/2,tileCollisionSize.x),n=min(e.y+t.y/2,tileCollisionSize.y);for(let e=a;e<n;++e)for(let t=s;t<o;++t){const s=tileCollision[e*tileCollisionSize.x+t];if(s&&(!i||i.ne(s,new Vector2(t,e))))return 1}}class TileLayerData{constructor(e,t=0,i=0,s=new Color){this.ge=e,this.direction=t,this.oe=i,this.color=s}clear(){this.ge=this.direction=this.oe=0,color=new Color}}class TileLayer extends EngineObject{constructor(e,t=tileCollisionSize,i=tileSizeDefault,s=vec2(1),a=0){super(e,t,-1,i,0,void 0,a),this.canvas=document.createElement("canvas"),this.context=this.canvas.getContext("2d"),this.scale=s,this.Te,this.data=[];for(let e=this.size.C();e--;)this.data.push(new TileLayerData)}setData(e,t,i){e.P(this.size)&&(this.data[(0|e.y)*this.size.x+e.x|0]=t,i&&this.Ce(e))}getData(e){return e.P(this.size)&&this.data[(0|e.y)*this.size.x+e.x|0]}update(){}k(){}ye(){const e=worldToScreen(this.j.add(vec2(0,this.size.y*this.scale.y)));(this.Te?overlayContext:mainContext).drawImage(this.canvas,e.x,e.y,cameraScale*this.size.x*this.scale.x,cameraScale*this.size.y*this.scale.y)}we(){this.Pe(1),this.be(),this.De()}Pe(e=0){e&&(this.canvas.width=this.size.x*this._.x,this.canvas.height=this.size.y*this._.y),this.Ie=[mainCanvas,mainContext,cameraPos,cameraScale],mainCanvas=this.canvas,mainContext=this.context,cameraPos=this.size.scale(.5),cameraScale=this._.x,enginePreRender()}De(){[mainCanvas,mainContext,cameraPos,cameraScale]=this.Ie}Ce(e){const t=e.floor().add(this.j).add(vec2(.5));this.xe(t,vec2(1),0,0,e=>e.clearRect(-.5,-.5,1,1));const i=this.getData(e);null!=i.ge&&drawTile(t,vec2(1),i.ge,this._,i.color,i.direction*PI/2,i.oe)}be(){for(let e=this.size.x;e--;)for(let t=this.size.y;t--;)this.Ce(vec2(e,t))}xe(e,t,i=0,s,a){const o=this.context;o.save(),e=e.l(this.j).multiply(this._),t=t.multiply(this._),o.translate(e.x,this.canvas.height-e.y),o.rotate(i),o.scale(s?-t.x:t.x,t.y),a(o),o.restore()}ze(e,t=vec2(1),i=-1,s=tileSizeDefault,a=new Color,o,n){this.xe(e,t,o,n,e=>{if(i<0)e.fillStyle=a,e.fillRect(-.5,-.5,1,1);else{const t=tileImage.width/s.x;e.globalAlpha=a.a,e.drawImage(tileImage,i%t*s.x,(i/t|0)*s.y,s.x,s.y,-.5,-.5,1,1)}})}Me(e,t,i,s){this.ze(e,t,-1,0,i,s)}}class ParticleEmitter extends EngineObject{constructor(e,t,i=0,s=0,a=100,o=PI,n=-1,r=tileSizeDefault,l=new Color,c=new Color,h=new Color(1,1,1,0),u=new Color(1,1,1,0),d=.5,m=.1,f=1,p=.1,v=.05,S=1,g=1,T=0,C=PI,y=.1,w=.2,P,b,D=1,I=(b?1e9:0)){super(e,new Vector2,n,r,t,void 0,I),this.Ee=i,this.Fe=s,this.Be=a,this.Le=o,this.Ge=l,this.ke=c,this.Re=h,this.je=u,this.Oe=D,this.Ae=d,this._e=m,this.Xe=f,this.speed=p,this.Ne=v,this.U=S,this.W=g,this.Y=T,this.Ue=C,this.We=y,this.me=w,this.q=P,this.Ve=b,this.Ke=0}update(){if(this.parent&&super.update(),!this.Fe||this.le()<=this.Fe){if(this.Be*particleEmitRateScale){const e=1/this.Be/particleEmitRateScale;for(this.Ke+=timeDelta;this.Ke>0;this.Ke-=e)this.Ye()}}else this.destroy()}Ye(){const e=null!=this.Ee.x?new Vector2(rand(-.5,.5),rand(-.5,.5)).multiply(this.Ee).rotate(this.angle):randInCircle(.5*this.Ee),t=new Particle(this.j.add(e),this.A,this._,this.angle+rand(this.Ue,-this.Ue)),i=this.me,s=e=>e+e*rand(i,-i),a=s(this.Ae),o=s(this._e),n=s(this.Xe),r=s(this.speed),l=s(this.Ne)*randSign(),c=rand(this.Le,-this.Le),h=randColor(this.Ge,this.ke,this.Oe),u=randColor(this.Re,this.je,this.Oe);return t.He=h,t.$e=u.l(h),t.H=(new Vector2).t(this.angle+c,r),t.$=l,t.Qe=a,t._e=o,t.Je=n-o,t.We=this.We,t.U=this.U,t.W=this.W,t.V=this.V,t.K=this.K,t.Y=this.Y,t.q=this.q,t.Ve=this.Ve,t.L=this.L,t.oe=rand()<.5,t.qe=this.Ze,this.et&&this.et(t),t}k(){}}class Particle extends EngineObject{constructor(e,t,i,s){super(e,new Vector2,t,i,s)}k(){const e=min((time-this.J)/this.Qe,1),t=this._e+e*this.Je,i=new Vector2(t,t),s=this.We/2,a=new Color(this.He.r+e*this.$e.r,this.He.g+e*this.$e.g,this.He.b+e*this.$e.b,(this.He.a+e*this.$e.a)*(e<s?e/s:e>1-s?(1-e)/s:1));this.Ve&&setBlendMode(1),drawTile(this.j,i,this.A,this._,a,this.angle,this.oe),this.Ve&&setBlendMode(),1==e&&(this.color=a,this.size=i,this.qe&&this.qe(this),this.G=1)}}const GFX={tt:{A:0,it:1,_:vec2(16),color:new Color(1,.2,.2,1),O:vec2(1.25,1.25),size:vec2(.5,.5),speed:.06,U:.85,st:.6,ot:{nt:.3,rt:.25,lt:4,width:.12,alpha:.8}},ct:{A:7,_:vec2(16),size:vec2(.8,.8),offset:.1,ht:.1,ut:vec2(.4,.3),dt:.1},ft:{A:-1,_:vec2(16),color:new Color(.05,.05,.05,1),size:vec2(.15,.15),speed:12,vt:2,St:{color:new Color(.05,.05,.05,.3),width:.12,gt:12,Tt:3},Ct:{yt:2,wt:.5,rangeMin:4,Pt:4,bt:.025}},Dt:{A:2,_:vec2(16),color:new Color(1,.35,.1,1),O:vec2(1.25,1.25),size:vec2(.72,.72),It:1.5,xt:2.2,zt:new Color(1,.35,.1,.5)},Mt:{A:-1,_:vec2(16),size:vec2(.22,.22),speed:8,vt:5,color:new Color(1,.2,0,1),St:{color:new Color(1,.35,.1,.4)}},Et:{A:-1,_:vec2(16),size:vec2(.22,.22),speed:8,vt:2,color:new Color(.3,.85,.15,1),St:{color:new Color(.3,.85,.15,.3)}},Ft:{A:4,frames:[5,6],_:vec2(16),color:new Color(.9,.2,.2,1),O:vec2(3,3),size:vec2(1.4,1.4),Bt:12,It:1.8,Lt:.1,Gt:.012,kt:{Rt:1.5,jt:80,Ot:{At:.6,_t:1.8,interval:.12,Xt:10,Nt:8},Ut:{duration:.2,Wt:.6,Vt:.06,Kt:7,Yt:.4},Ht:{interval:.3,$t:6,Qt:6,Jt:4,qt:2,Zt:.7}}}},_F=e=>"bold "+e+"px Arial,sans-serif",ENGINE={ei:vec2(1280,720),ti:36,font:"'Courier New',Courier,monospace"},GAMEPLAY={ii:1,si:.05,ai:.01,oi:.12,ni:.6},SHOOTING={ri:.21,li:3,ci:.08},ENEMY={hi:.035,ui:.35,di:1.2,mi:.15},INPUT={fi:60,pi:8,Si:.35,gi:new Color(1,1,1,.15),Ti:new Color(1,1,1,.3),Ci:new Color(1,1,1,.45),yi:new Color(.8,.15,.1,.25),wi:new Color(.9,.2,.15,.55),Pi:new Color(.85,.15,.1,.7)},HUD={bi:{width:500,height:18,y:18,padding:2}},SCREENS={Di:{duration:2.8,Ii:1.8,xi:10,zi:120,letterSpacing:"8px"},title:{Mi:80,Ei:-80,Fi:"8px",Bi:200,Li:60,Gi:90,ki:12,Ri:new Color(1,.35,.25,.9),ji:36},Oi:{Ai:220,_i:200,Xi:40,Ni:20,Ui:14,Wi:40,Vi:60,Ki:"6px",Yi:14,Hi:145,$i:14,Qi:20,Ji:.1,qi:.3,Zi:30,es:new Color(.35,.9,.35,.6),ts:new Color(.5,.5,.6,.55),ss:new Color(.22,.22,.3,.85),ns:new Color(.6,1,.6,1),rs:new Color(.7,.7,.8,.75),ls:4,cs:2.5,hs:400}},PARTICLES={us:{Ee:.1,Fe:.3,Be:120,Le:.1,A:-1,_:vec2(16),Ge:new Color(1,.965,.784,1),ke:new Color(1,.82,.4,1),Re:new Color(1,.549,.259,0),je:new Color(1,.549,.259,0),Ae:.5,_e:.25,Xe:.1,speed:.05,Ne:.05,U:.9,W:1,Y:0,ds:0,We:.25,me:0,q:1,Ve:1,offset:1},fs:{Ee:1,Fe:.1,Be:80,Le:3.14,A:-1,_:vec2(16),Ge:new Color(1,.863,.627,1),ke:new Color(1,.863,.627,1),Re:new Color(.627,.471,.314,0),je:new Color(.627,.471,.314,0),Ae:.25,_e:.35,Xe:.1,speed:.4,Ne:.11,U:.75,W:.92,Y:.4,ds:3.14,We:.3,me:.25,q:0,Ve:1}},MUSIC_FILE=[[[,0,77,,,.7,2,.41,,,,,,,,.06],[,0,43,.01,,.3,2,,,,,,,,,.02,.01],[,0,170,.003,,.008,,.97,-35,53,,,,,,.1],[.8,0,270,,,.12,3,1.65,-2,,,,,4.5,,.02],[,0,86,,,,,.7,,,,.5,,6.7,1,.05],[,0,41,,.05,.4,2,0,,,9,.01,,,,.08,.02],[,0,2200,,,.04,3,2,,,800,.02,,4.8,,.01,.1],[.3,0,16,,,.3,3]],[[[1,-1,21,21,33,21,21,33,21,21,33,21,21,33,21,21,33,33,21,21,33,21,21,33,21,21,33,21,21,33,21,21,33,33,21,21,33,21,21,33,21,21,33,21,21,33,21,21,33,33,21,21,33,21,21,33,21,21,33,21,21,33,21,21,33,33],[3,1,22,,,,,,,,,,,,,,,,,,,,,,,,,,,,24,,,,24,,,,,,,,,,,,,,,,,,,,,,,,22,,22,,22,,,,],[5,-1,21,,,,,,,,,,,,,,,,,,,,,,,,,,,,24,,,,23,,,,,,,,,,,,,,,,,,,,,,,,24,,23,,21,,,,],[,1,21,,,,,,,,,,,,,,,,,,,,,,,,,,,,24,,,,23,,,,,,,,,,,,,,,,,,,,,,,,24,,23,,21,,,,]],[[1,-1,21,21,33,21,21,33,21,21,33,21,21,33,21,21,33,33,21,21,33,21,21,33,21,21,33,21,21,33,21,21,33,33,21,21,33,21,21,33,21,21,33,21,21,33,21,21,33,33,21,21,33,21,21,33,21,21,33,21,21,33,21,21,33,33],[3,1,24,,,,,,,,27,,,,,,,,,,,,,,,,27,,,,24,,,,24,,,,,,,,27,,,,,,,,,,,,,,,,24,,24,,24,,,,],[5,-1,21,,,,,,,,,,,,,,,,,,,,,,,,,,,,24,,,,23,,,,,,,,,,,,,,,,,,,,,,,,24,,23,,21,,,,],[,1,21,,,,,,,,,,,,,,,,,,,,,,,,,,,,24,,,,23,,,,,,,,,,,,,,,,,,,,,,,,24,,23,,21,,,,],[6,1,,,34,34,34,,,,,,34,34,,,,,34,,,,34,34,,,,,34,,,,34,,,,34,34,34,,,,,,34,,,,,,34,34,,,34,34,,,,,,,,,34,34],[4,1,,,,,,,24,,,,,,24,,24,,,,24,,,,24,,,,,,,,,,,,,,,,24,,,,,,24,,24,,,,24,,,,24,,,,,,,,,,]],[[1,-1,21,21,33,21,21,33,21,21,33,21,21,33,21,21,33,33,21,21,33,21,21,33,21,21,33,21,21,33,21,21,33,33,23,23,35,23,23,36,23,23,35,23,23,36,23,23,35,35,23,23,35,23,23,35,23,23,36,23,23,35,23,23,36,36],[5,-1,21,,,19,,,21,,,,,,,,,,21,,,19,,,17,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,],[3,1,24,,,24,,,24,,,,,,,,,,24,,,24,,,24,,,,24.75,24.5,24.26,24.01,24.01,24.01,,,,,25,,,,,,,,25,,,,,,,,25,,,,,,,,25,25,25,25],[4,-1,,,,,,,,,,,,,,,,,,,,,,,,,,,24.75,24.5,24.26,24.01,24.01,24.01,24.01,24,,24,24,,24,24,24,24,,24,24,,24,,24,24,,24,24,,24,24,24,24,,24,24,,24,24],[7,-1,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,23,,21,23,,35,,23,,21,23,,35,,35,,23,,21,23,,35,,21,23,,35,,21,23,,,],[6,1,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,34,36,34,,33,34,34,36,31,36,34,,31,34,32,,33,36,34,,31,34,34,36,33,36,33,,31,,,]],[[1,-1,21,21,33,21,21,33,21,21,33,21,21,33,21,21,33,33,21,21,33,21,21,33,21,21,33,21,21,33,21,21,33,33,17,17,29,17,17,29,17,17,29,17,17,29,17,17,29,29,17,17,29,17,17,29,17,17,29,17,17,29,17,17,29,29],[4,1,24,24,,24,24,,24,24,24,24,,24,24,,24,,24,24,,24,24,,24,24,24,24,,24,24,,24,24,24,24,,24,24,,24,24,24,,,24,24,,24,,24,24,,24,24,,24,24,24,24,,24,24,,24,24],[7,-1,21,,19,21,,33,,21,,19,21,,33,,33,,21,,19,21,,33,,21,,19,21,,33,,33,,17,,17,17,29,17,17,29,17,,17,17,29,17,17,29,17,,17,17,29,17,17,29,17,,17,17,29,17,17,29],[2,1,,34,34,34,,34,34,34,,34,34,34,,34,34,34,,34,34,34,,34,34,34,,34,34,34,,34,,,,34,34,34,,34,34,34,,34,34,34,,34,34,34,,34,34,34,,34,34,34,,34,34,34,,34,,,],[6,1,,,36,,,,,,36,,36,,,,,,,,36,,,,,,36,,36,,,,,,,,36,,,,,,,,,,,,,,,,36,,,,,,36,,36,,,,,,],[3,1,,,,,25,,,,,,,,25,,,,,,,,25,,,,,,,,25,25,25,25,,,,,25,,,,,25,,,25,,,,,,,,25,,,,,,,,25,25,25,25]],[[1,-1,14,14,26,14,14,26,14,14,26,14,14,26,14,14,26,26,14,14,26,14,14,26,14,14,26,14,14,26,14,14,26,26,17,17,29,17,17,29,17,17,29,17,17,29,17,17,29,29,19,19,31,19,19,31,19,19,31,19,19,31,19,19,31,31],[4,1,24,24,,24,24,,24,24,24,24,,24,24,,24,,24,24,,24,24,,24,24,24,24,,24,24,,24,24,24,24,,24,24,,24,24,24,24,,24,24,,36,,24,24,,24,24,,24,24,24,24,,24,24,,24,24],[7,-1,14,,14,14,26,14,14,26,14,,14,14,26,14,14,26,14,,14,14,26,14,14,26,14,,14,14,26,14,14,26,17,,17,17,29,17,17,29,17,,17,17,29,17,17,29,19,,19,19,31,19,19,31,19,,19,19,31,19,19,31],[2,1,,36,36,36,,36,36,36,,36,36,36,,36,36,36,,36,36,36,,36,36,36,,36,36,36,,36,,,,36,36,36,,36,36,36,,36,36,36,,36,36,36,,36,36,36,,36,36,36,,36,36,36,,36,,,],[3,1,,,,,25,,,,,,,,25,,,,,,,,25,,,,,,,,25,25,25,25,,,,,25,,,,,,,,25,,,,,,,,25,,,,,,,,25,25,25,25],[6,1,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,34,,,,,,34,,34,,,,,,,,34,,,,,,34,,34,,,,,,]]],[0,1,1,2,3,4,4]],B0=0,B1=2863311530,B2=2631680,B3=289673540,B4=2692743168,B5=2852126890,B6=3222011952,B7=2897920,BLOCKS=[0,B1,B2,B3,B4,B5,B6,B7];function _cell(e,t,i){return e>>>2*(15-(4*t+i))&3}const TUTORIAL_LEVELS=[{ps:4,vs:3,Ss:0,gs:[0,0,0,0,0,0,0,0,0,0,0,0],Ts:[8.5,5.5],Cs:[]},{ps:4,vs:3,Ss:1,gs:[0,0,0,0,0,0,0,0,0,0,0,0],Ts:[4.5,5.5],Cs:[[11.5,5.5],[8.5,8.5],[5.5,8.5]]},{ps:5,vs:3,Ss:2,gs:[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],Ts:[10.5,5.5],Cs:[[4.5,9.5],[16.5,9.5]]},{ps:5,vs:3,Ss:3,gs:[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],Ts:[10.5,5.5],Cs:[[16.5,5.5],[4.5,9.5],[16.5,9.5]]}],LEVEL_DEFINITIONS=[{ps:7,vs:3,gs:[0,0,0,0,0,0,0,0,4,0,2,0,4,0,0,0,0,3,0,0,0],Ts:[2.5,5.5],Cs:[[18.5,5.5],[14.5,9.5],[6.5,9.5],[22.5,9.5],[10.5,5.5]]},{ps:10,vs:6,gs:[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],Ts:[6.5,5.5],Cs:[],Ft:[20.5,12.5]}];function decodeLevelTiles(e,t,i){const s=4*e,a=4*t,o=[],n=[];for(let e=0;e<s;e++)n[e]=[];for(let t=0;t<a;t++)for(let r=0;r<s;r++){const l=a-1-t;let c;if(0===t||t===a-1||0===r||r===s-1)c=2;else{const s=i[(t/4|0)*e+(r/4|0)];c=_cell(BLOCKS[s],t%4,r%4)}n[r][l]=c,c>=2&&o.push(vec2(r,l))}return{ys:o,ws:n,w:s,Ps:a}}function parseLevelDefinition(e){const{ps:t,vs:i,gs:s}=e,{ys:a,ws:o,w:n,Ps:r}=decodeLevelTiles(t,i,s);return{width:n,height:r,size:vec2(n,r),ys:a,ws:o,Cs:(e.Cs||[]).map(e=>({j:vec2(e[0],e[1])})),bs:vec2(e.Ts[0],e.Ts[1]),Ds:e.Ft?vec2(e.Ft[0],e.Ft[1]):null}}function mulberry32(e){let t=0|e;return function(){t=t+1831565813|0;let e=Math.imul(t^t>>>15,1|t);return e=e+Math.imul(e^e>>>7,61|e)^e,((e^e>>>14)>>>0)/4294967296}}let _proceduralCount=0;const _IBLOCKS=[0,0,0,0,2,3,4,6,7];function _testWall(e,t,i,s,a,o){if(a<0||o<0||a>=i||o>=s)return!0;const n=s-1-o,r=a;if(0===n||n===s-1||0===r||r===i-1)return!0;const l=e[(n/4|0)*t+(r/4|0)];return _cell(BLOCKS[l],n%4,r%4)>=2}function _clear(e,t,i,s,a,o){for(let n=-1;n<=1;n++)for(let r=-1;r<=1;r++)if(_testWall(e,t,i,s,a+r,o+n))return!1;return!0}function generateProceduralLevel(e){_proceduralCount++;const t=mulberry32(7919*_proceduralCount+31*(e=e||1)),i=e=>t()*e|0,s=min(6+(e/2|0),9),a=min(3+(e/3|0),5),o=4*s,n=4*a,r=[];for(let e=0;e<a;e++)for(let t=0;t<s;t++)r.push(0===t||t===s-1||0===e||e===a-1?0:_IBLOCKS[i(_IBLOCKS.length)]);if(s>2&&a>2){let e=!1;for(let t=0;t<r.length;t++)if(0!==r[t]&&3!==r[t]){e=!0;break}e||(r[s+1+i(s-2)]=_IBLOCKS[4+i(_IBLOCKS.length-4)])}let l=2,c=2;for(let e=0;e<50&&(l=2+i(4),c=2+i(3),!_clear(r,s,o,n,l,c));e++);const h=min(2+e,10),u=[];let d=0;for(;u.length<h&&d++<300;){const e=2+i(o-4),t=2+i(n-4);if(abs(e-l)+abs(t-c)<6)continue;if(!_clear(r,s,o,n,e,t))continue;if(0!==r[((n-1-t)/4|0)*s+(e/4|0)])continue;let a=!1;for(const i of u)if(abs(i[0]-e)<2&&abs(i[1]-t)<2){a=!0;break}a||u.push([e+.5,t+.5])}return{ps:s,vs:a,gs:r,Ts:[l+.5,c+.5],Cs:u}}const _GOLD=new Color(.85,.65,.13,1),_ACID=new Color(.5,1,.3,.6),_WHITE=new Color(1,1,1,1);function _gunTransform(e,t,i,s){const a=GFX.ct,o=i+s,n=vec2(t.y,-t.x),r=e.add(n.scale(a.dt)).add(t.scale(o)),l=vec2(-t.y,t.x),c=t.x<0,h=a.ut,u=r.add(t.scale(h.x)).add(l.scale(h.y*(c?-1:1)));return{Is:r,xs:u,angle:-Math.atan2(t.y,t.x)-(c?PI:0),oe:c}}function _drawGun(e,t,i,s){const{Is:a,angle:o,oe:n}=_gunTransform(e,t,i,s);drawTile(a,GFX.ct.size,GFX.ct.A,GFX.ct._,new Color,o,n)}function firePlayerBullet(e,t){new Bullet(e,t),emitShotParticles(e,t,0)}class Player extends EngineObject{constructor(e){const t=GFX.tt;super(e.o(),t.size,t.A,t._,0,t.color),this.speed=getEffectivePlayerSpeed(),this.H=vec2(0,0),this.ot=vec2(1,0),this.N=1,this.U=1,this.Y=0,this.ue(1,1,1)}update(){super.update();const e=.5*this.size.x,t=.5*this.size.y;this.j.x=clamp(this.j.x,e,levelSize.x-e),this.j.y=clamp(this.j.y,t,levelSize.y-t),this.H=this.H.scale(GFX.tt.U)}get zs(){return.5*GFX.tt.O.x+GFX.ct.offset}get Ms(){return this.ot.length()>.001?this.ot.normalize():vec2(1,0)}get Es(){return _gunTransform(this.j,this.Ms,.5*GFX.tt.O.x,GFX.ct.offset).xs}k(){const e=this.H.length()>GAMEPLAY.ai?GFX.tt.A+(6*time|0)%2*GFX.tt.it:GFX.tt.A,t=this.ot.x<0;drawTile(this.j,GFX.tt.O,e,GFX.tt._,new Color,0,t),0!==tutorialPhase&&2!==tutorialPhase&&_drawGun(this.j,this.Ms,.5*GFX.tt.O.x,GFX.ct.offset)}}class Bullet extends EngineObject{constructor(e,t,i,s,a=1){const o=a?GFX.ft:GFX.Mt;super(e.o(),o.size,o.A,o._,0,s??o.color??GFX.Dt.color),this.direction=t.normalize(),this.speed=i??(a?GFX.ft.speed:o.speed),this.Fs=a,this.vt=o.vt??GFX.ft.vt,this.U=1,this.Y=0,this.ue(1,0,1);const n=o.St??GFX.ft.St;this.St={points:[],color:n.color},bulletTrails.push(this.St)}update(){if(this.Fs&&activeBuffs.Ct){const e=GFX.ft.Ct;let t=null,i=1/0;const s=[...turrets];boss&&!boss.G&&s.push(boss);for(const a of s){if(a.G)continue;const s=a.j.l(this.j),o=s.length();if(o<.01)continue;if(s.S(this.direction)<0)continue;const n=abs(s.x*this.direction.y-s.y*this.direction.x)*e.yt+o*e.wt;n<i&&(i=n,t=a)}if(t){const i=t.j.l(this.j),s=i.length(),a=clamp(1-(s-e.rangeMin)/e.Pt,0,1)*e.bt;if(a>0){const e=i.normalize();this.direction=this.direction.add(e.scale(a)).normalize()}}}this.H=this.direction.scale(this.speed*timeScale*timeDelta),super.update(),this.St.points.length>=GFX.ft.St.gt&&this.St.points.shift(),this.St.points.push({j:this.j.o(),alpha:1}),this.vt-=timeDelta*timeScale,this.vt<=0&&this.destroy()}k(){const e=-Math.atan2(this.direction.y,this.direction.x);if(this.Fs){const t=.3,i=.12;drawRect(this.j,vec2(t,i),this.color,e);const s=.8*i;drawRect(this.j.add(this.direction.scale(.5*t)),vec2(s,s),_GOLD,e)}else{this.Bs||(this.Bs=0),this.Bs+=8*timeDelta*timeScale;const e=.28,t=GFX.Mt;drawRect(this.j,vec2(1.6*e),new Color(1,.35,.1,.35),this.Bs),drawRect(this.j,vec2(e,e),t.color||this.color,this.Bs)}}destroy(){this.G||super.destroy()}ne(e,t){return e>0?(this.destroy(),1):0}ae(e){return this.Fs&&e instanceof Turret?(this.destroy(),emitDeathParticles(e.j),playEnemyKillSound(),e.destroy(),reloadTimer=0):this.Fs&&e instanceof Boss?(this.destroy(),e.Ls(activeBuffs.Ct?2:1),reloadTimer=0):!this.Fs&&e instanceof Player&&(this.destroy(),emitDeathParticles(e.j),killPlayer()),0}}class TurretBullet extends Bullet{constructor(e,t,i){super(e,t,i??GFX.Mt.speed,GFX.Dt.color,0),this.Gs=1/0}update(){if(super.update(),player&&2===tutorialPhase){const e=this.j.l(player.j).length();e<this.Gs&&(this.Gs=e)}}destroy(){2===tutorialPhase&&this.Gs<3&&player&&!restarting&&tutorialDodgeCount++,super.destroy()}}class BossBullet extends Bullet{constructor(e,t,i){const s=GFX.Et;super(e,t,i??s.speed,s.color,0),this.ks=!0,this.Rs=3*this.j.x}k(){this.Rs+=.2*timeScale;const e=Math.atan2(this.direction.y,this.direction.x),t=.06*Math.sin(this.Rs),i=.26+t,s=.2-t;drawRect(this.j,vec2(i,s),this.color,e),drawRect(this.j,vec2(.5*i,.5*s),_ACID,e)}}function _slideMove(e,t){const i=e.size,s=e.j.add(t);if(!tileCollisionTest(s,i))return e.j=s,!0;if(abs(t.x)>1e-4){const s=vec2(e.j.x+t.x,e.j.y);if(!tileCollisionTest(s,i))return e.j=s,!0}if(abs(t.y)>1e-4){const s=vec2(e.j.x,e.j.y+t.y);if(!tileCollisionTest(s,i))return e.j=s,!0}return!1}const _BFS_DIRS=[vec2(1,0),vec2(-1,0),vec2(0,1),vec2(0,-1),vec2(1,1),vec2(-1,1),vec2(1,-1),vec2(-1,-1)];function _bfsNextWaypoint(e,t){const i=0|e.x,s=0|e.y,a=0|t.x,o=0|t.y,n=0|tileCollisionSize.x,r=0|tileCollisionSize.y;if(i===a&&s===o)return null;const l=new Uint8Array(n*r),c=[];l[s*n+i]=1;for(const e of _BFS_DIRS){const t=i+e.x,h=s+e.y;if(t<0||t>=n||h<0||h>=r)continue;const u=h*n+t;if(!l[u]){if(0!==e.x&&0!==e.y){if(getTileCollisionData(vec2(i+e.x,s))>0)continue;if(getTileCollisionData(vec2(i,s+e.y))>0)continue}if(!(getTileCollisionData(vec2(t,h))>0)){if(l[u]=1,t===a&&h===o)return vec2(t+.5,h+.5);c.push({x:t,y:h,js:t,Os:h})}}}let h=0;for(;h<c.length;){const e=c[h++];for(const t of _BFS_DIRS){const i=e.x+t.x,s=e.y+t.y;if(i<0||i>=n||s<0||s>=r)continue;const h=s*n+i;if(!l[h]){if(0!==t.x&&0!==t.y){if(getTileCollisionData(vec2(e.x+t.x,e.y))>0)continue;if(getTileCollisionData(vec2(e.x,e.y+t.y))>0)continue}if(!(getTileCollisionData(vec2(i,s))>0)){if(l[h]=1,i===a&&s===o)return vec2(e.js+.5,e.Os+.5);c.push({x:i,y:s,js:e.js,Os:e.Os})}}}}return null}class Turret extends EngineObject{constructor(e){const t=GFX.Dt;super(e.o(),t.size,t.A,t._,0,t.color),this.As=t.It,this._s=this.As,this.N=0,this.U=1,this.Y=0,this.ue(1,1,1),this.Xs=null,this.Ns=0,this.Us=0}k(){const e=playerIsMoving?GFX.Dt.A+(4*time|0)%2:GFX.Dt.A,t=player&&player.j.x<this.j.x;if(drawTile(this.j,GFX.Dt.O,e,GFX.Dt._,new Color,0,t),player){const e=this.Ms;_drawGun(this.j,e,.5*GFX.Dt.O.x,GFX.ct.ht)}}get Ms(){if(!player)return vec2(1,0);const e=player.j.l(this.j);return e.length()>.001?e.normalize():vec2(1,0)}get Es(){return _gunTransform(this.j,this.Ms,.5*GFX.Dt.O.x,GFX.ct.ht).xs}update(){if(!player)return;{const e=player.j.l(this.j).length();if(this.Ns-=timeDelta*timeScale,this.Ns<=0&&(this.Ns=ENEMY.ui,this.Xs=e>ENEMY.di?_bfsNextWaypoint(this.j,player.j):null),this.Xs&&e>ENEMY.di){const e=this.Xs.l(this.j);if(e.length()<ENEMY.mi)this.Ns=0,this.Us=0;else{if(_slideMove(this,e.normalize().scale(ENEMY.hi*timeScale)))this.Us=0;else if(this.Us++,this.Ns=0,this.Us>2){_slideMove(this,vec2(.5+(0|this.j.x),.5+(0|this.j.y)).l(this.j).scale(.15))}}}}if(this._s-=timeDelta*timeScale,this._s>0)return;this._s=this.As;const e=player.j.l(this.j);if(e.length()<=.001)return;const t=e.normalize(),i=this.Es;new TurretBullet(i,t,this.Ws),emitShotParticles(i,t),playShotSound(.7)}}class DummyTurret extends Turret{constructor(e){super(e),this._s=1/0}update(){}k(){const e=playerIsMoving?GFX.Dt.A+(4*time|0)%2:GFX.Dt.A,t=player&&player.j.x<this.j.x;drawTile(this.j,GFX.Dt.O,e,GFX.Dt._,new Color,0,t)}}const BOSS_MOVE_MACHINEGUN=0,BOSS_MOVE_DASH=1,BOSS_MOVE_SIDERAIN=2;class Boss extends EngineObject{constructor(e){const t=GFX.Ft;super(e.o(),t.size,t.A,t._,0,t.color),this.Bt=t.Bt,this.Vs=t.Bt,this.N=0,this.U=1,this.Y=0,this.ue(1,1,1),this.Ks=t.It,this.Ys=this.Ks,this.Hs=-1,this.$s=0,this.Qs=0,this.Js=0,this.qs=0,this.Zs=null,this.ea=vec2(),this.ta=0,this.ia=0,this.sa=e.o(),this.Xs=null,this.Ns=0,this.Us=0}k(){let e;e=1===this.Hs?GFX.Ft.A:2===this.Hs?GFX.Ft.frames[1]:GFX.Ft.frames[0];const t=player&&player.j.x<this.j.x,i=GFX.Ft.O;let s,a;if(playerIsMoving){const e=.12*Math.sin(9*time);s=vec2(i.x-e,i.y+e),a=vec2(this.j.x,this.j.y+.5*e)}else s=i,a=this.j;drawTile(a,s,e,GFX.Ft._,this.color,0,t)}get aa(){return 1-this.Bt/this.Vs}get oa(){return 1+this.aa*GFX.Ft.kt.Rt}na(){return this.Ks/this.oa}Ls(e){this.Bt=max(0,this.Bt-e),emitDeathParticles(this.j),playEnemyKillSound(),this.color=_WHITE,setTimeout(()=>{this.G||(this.color=GFX.Ft.color)},GFX.Ft.kt.jt),this.Bt<=0&&this.ra()}ra(){emitDeathParticles(this.j),playEnemyKillSound(),this.destroy()}la(){let e;do{e=randInt(3)}while(e===this.Hs);if(this.Hs=e,this.Qs=0,0===e){const e=player?player.j.l(this.j).normalize():vec2(1,0);this.ca=e.rotate(-GFX.Ft.kt.Ot.At),this.qs=0,this.$s=0}else 1===e?(player&&(this.Zs=player.j.o(),this.ea=player.j.l(this.j).normalize()),this.$s=0):(this.ta=0,this.ia=0,this.$s=0)}update(){if(!player||this.G)return;const e=timeDelta*timeScale;if(this.Ns-=e,this.Ns<=0){this.Ns=ENEMY.ui;const e=player.j.l(this.j).length();this.Xs=e>ENEMY.di?_bfsNextWaypoint(this.j,player.j):null}if(this.Xs){const e=this.Xs.l(this.j);if(e.length()<ENEMY.mi)this.Ns=0,this.Us=0;else{if(_slideMove(this,e.normalize().scale(GFX.Ft.Gt*timeScale)))this.Us=0;else if(this.Us++,this.Ns=0,this.Us>2){_slideMove(this,vec2(.5+(0|this.j.x),.5+(0|this.j.y)).l(this.j).scale(.1))}}}if(this.sa=this.j.o(),this.Hs<0)return this.Ys-=e,void(this.Ys<=0&&(this.la(),this.Ys=this.na()));if(0===this.Hs){this.$s+=e;const t=GFX.Ft.kt.Ot,i=t.interval/this.oa,s=t.Xt+this.aa*t.Nt|0;if(this.$s>=i&&this.qs<s){this.$s-=i,this.qs++;const e=this.ca.rotate(this.qs/s*t._t);new BossBullet(this.j,e),emitShotParticles(this.j,e),playShotSound(.65)}this.qs>=s&&(this.Hs=-1,this.Ys=this.na())}else if(1===this.Hs){this.$s+=e;const t=GFX.Ft.kt.Ut;if(0===this.Qs){if(_slideMove(this,this.ea.scale(GFX.Ft.Lt*this.oa*timeScale)),this.$s>t.duration||this.j.l(this.Zs).length()<1){this.Qs=1;const e=player.j.l(this.j).normalize(),i=(t.Kt-1)/2;for(let s=-i;s<=i;s++){const i=e.rotate(s*t.Yt);new BossBullet(this.j,i),emitShotParticles(this.j,i)}playShotSound(.7),this.$s=0}}else{const e=this.sa.l(this.j);if(e.length()>.2){_slideMove(this,e.normalize().scale(t.Vt*timeScale))}this.$s>t.Wt&&(this.Hs=-1,this.Ys=this.na())}}else if(2===this.Hs){this.$s+=e;const t=GFX.Ft.kt.Ht,i=t.interval/this.oa,s=t.$t+this.aa*t.Qt|0;if(this.ta+=e,this.ta>=i&&this.ia<s){this.ta-=i,this.ia++;const e=rand(2,levelSize.y-2),s=rand(t.Jt,t.Jt+t.qt),a=vec2(1,rand(-.5,.5)*t.Zt),o=vec2(2,e);new BossBullet(o,a,s);const n=rand(2,levelSize.y-2),r=vec2(-1,rand(-.5,.5)*t.Zt),l=vec2(levelSize.x-2,n);new BossBullet(l,r,s),emitShotParticles(o,a),emitShotParticles(l,r),playShotSound(.65)}this.ia>=s&&(this.Hs=-1,this.Ys=this.na())}}}function killPlayer(){if(restarting)return;playPlayerDeathSound(),restarting=!0,screenFlashAlpha=1,player&&player.destroy();tutorialPhase>=0?setTimeout(()=>loadTutorialStep(tutorialPhase),350):predefinedLevelsBeaten?setTimeout(()=>{loadLevel(generateProceduralLevel(proceduralDifficulty))},350):setTimeout(()=>loadLevel(currentLevelIndex),350)}let joystickActive=!1,joystickOrigin=vec2(),joystickKnob=vec2(),joystickDir=vec2(),joystickMag=0,aimActive=!1,aimOrigin=vec2(),aimKnob=vec2(),aimDir=vec2(),aimMag=0,joystickTouchId=-1,aimTouchId=-1,shootPressed=!1;function updateJoystickFromScreenPos(e){const t=e.l(joystickOrigin),i=t.length();i>INPUT.pi?(joystickDir=t.normalize(),joystickMag=clamp((i-INPUT.pi)/(INPUT.fi-INPUT.pi),0,1)):(joystickDir=vec2(),joystickMag=0),joystickKnob=joystickOrigin.add(i>.001?t.normalize(Math.min(i,INPUT.fi)):vec2())}function updateAimFromScreenPos(e){const t=e.l(aimOrigin),i=t.length();i>INPUT.pi?(aimDir=t.normalize(),aimMag=clamp((i-INPUT.pi)/(INPUT.fi-INPUT.pi),0,1)):(aimDir=vec2(),aimMag=0),aimKnob=aimOrigin.add(i>.001?t.normalize(Math.min(i,INPUT.fi)):vec2())}function resetInputState(){joystickActive=!1,joystickMag=0,joystickTouchId=-1,aimActive=!1,aimMag=0,aimTouchId=-1,shootPressed=!1,reloadTimer=0,burstQueue=0,burstTimer=0}function initTouchInput(){const e=e=>{const t=mainCanvas.getBoundingClientRect();return vec2((e.clientX-t.left)*mainCanvas.width/t.width,(e.clientY-t.top)*mainCanvas.height/t.height)},t=e=>e.x>.5*mainCanvasSize.x;document.addEventListener("touchstart",i=>{if("title"!==gameState)if("powerup"!==gameState){if("playing"===gameState)for(const s of i.changedTouches){const i=e(s);t(i)&&aimTouchId<0?(aimTouchId=s.identifier,aimActive=!0,aimOrigin=i,aimKnob=i,aimDir=vec2(),aimMag=0):!t(i)&&joystickTouchId<0&&(joystickTouchId=s.identifier,joystickActive=!0,joystickOrigin=i,joystickKnob=i,joystickDir=vec2(),joystickMag=0)}}else for(const t of i.changedTouches){const i=e(t);handlePowerupTap(i.x,i.y)}else startGame()},{passive:!0}),document.addEventListener("touchmove",t=>{for(const i of t.changedTouches)i.identifier===joystickTouchId&&updateJoystickFromScreenPos(e(i)),i.identifier===aimTouchId&&updateAimFromScreenPos(e(i))},{passive:!0}),document.addEventListener("touchend",e=>{for(const t of e.changedTouches)t.identifier===joystickTouchId&&(joystickTouchId=-1,joystickActive=!1,joystickMag=0),t.identifier===aimTouchId&&(aimMag>0&&(shootPressed=!0),aimTouchId=-1,aimActive=!1,aimMag=0)},{passive:!0}),document.addEventListener("touchcancel",e=>{for(const t of e.changedTouches)t.identifier===joystickTouchId&&(joystickTouchId=-1,joystickActive=!1,joystickMag=0),t.identifier===aimTouchId&&(aimTouchId=-1,aimActive=!1,aimMag=0)},{passive:!0})}const _TITLE="QUICKSILVER";function updateIntro(){stateTime>=SCREENS.Di.duration&&(gameState="title",stateTime=0)}function updateTitle(){(mouseWasPressed(0)||keyWasPressed(32)||keyWasPressed(13))&&startGame()}function renderIntro(){const e=mainCanvasSize.x/2,t=mainCanvasSize.y/2,i=stateTime,s=SCREENS.Di;if(drawRect(vec2(0),vec2(999),new Color(0,0,0)),i<s.Ii){const a=i/s.Ii,o=lerp(a*a,s.xi,s.zi),n=clamp(2*a,0,1);overlayContext.save(),overlayContext.letterSpacing=s.letterSpacing,drawTextScreen(_TITLE,vec2(e,t),o,new Color(1,1,1,n)),overlayContext.restore()}else{const a=(i-s.Ii)/(s.duration-s.Ii),o=1-a,n=.3*Math.sin(a*PI*6)*(1-a);drawRect(vec2(0),vec2(999),new Color(1,.2,.1,max(0,n))),overlayContext.save(),overlayContext.letterSpacing=s.letterSpacing,drawTextScreen(_TITLE,vec2(e,t),s.zi,new Color(1,1-.5*a,1-.5*a,o)),overlayContext.restore()}}function renderTitle(){const e=overlayContext,t=mainCanvasSize.x/2,i=mainCanvasSize.y/2,s=stateTime,a=SCREENS.title,o=clamp(s/.5,0,1);drawRect(vec2(0),vec2(999),new Color(.08,.08,.1)),e.save(),e.letterSpacing=a.Fi,drawTextScreen(_TITLE,vec2(t,i+a.Ei),a.Mi,new Color(1,1,1,o)),e.restore();const n=.85+.15*Math.sin(3*s),r=a.Bi*n,l=a.Li*n,c=i+a.Gi;e.save(),e.globalAlpha=o,e.fillStyle=a.Ri.toString(),e.beginPath(),e.roundRect(t-r/2,c-l/2,r,l,a.ki),e.fill(),e.restore(),drawTextScreen("PLAY",vec2(t,c+2),a.ji,new Color(1,1,1,o))}const POWERUP_TIERS=[[{ic:"+",ha:"-20% Reload",apply(){activeBuffs.ua*=.8}},{ic:">",ha:"+10% Speed",apply(){activeBuffs.da*=1.1}},{ic:"@",ha:"-3% Slow-mo",apply(){activeBuffs.ma-=.03}}],[{ic:"*",ha:"Homing Bullets",apply(){activeBuffs.Ct=!0}},{ic:"#",ha:"Buckshot",apply(){activeBuffs.fa=!0}},{ic:"!",ha:"Triple Burst",apply(){activeBuffs.pa=!0}}]],DEFAULT_BUFFS={da:1,ua:1,ma:0,Ct:!1,fa:!1,pa:!1};let activeBuffs={...DEFAULT_BUFFS};function resetBuffs(){activeBuffs={...DEFAULT_BUFFS}}function getEffectivePlayerSpeed(){return GFX.tt.speed*activeBuffs.da}function getEffectiveSlowScale(){return max(.02,GAMEPLAY.si+activeBuffs.ma)}function getEffectiveReloadTime(){return GAMEPLAY.ii*activeBuffs.ua}let gameMusic,powerupChoices=[],powerupSelected=-1,powerupPendingLevel=0;function preparePowerupChoices(e){const t=POWERUP_TIERS[e];if(!t)return;const i=[...t].sort(()=>Math.random()-.5);powerupChoices=i.slice(0,3),powerupSelected=-1}function _getCardLayout(){const e=SCREENS.Oi,t=mainCanvasSize.x/2,i=mainCanvasSize.y/2,s=powerupChoices.length*e.Ai+(powerupChoices.length-1)*e.Xi;return{va:e.Ai,Sa:e._i,gap:e.Xi,ga:t-s/2,Ta:i-e._i/2+e.Ni,cx:t,cy:i}}function handlePowerupTap(e,t){if(powerupSelected>=0||!powerupChoices.length)return;const{va:i,Sa:s,gap:a,ga:o,Ta:n}=_getCardLayout();for(let r=0;r<powerupChoices.length;r++){const l=o+r*(i+a);if(e>=l&&e<=l+i&&t>=n&&t<=n+s)return void selectPowerup(r)}}function selectPowerup(e){powerupSelected>=0||(powerupSelected=e,powerupChoices[e].apply(),setTimeout(()=>{gameState="playing",stateTime=0,loadLevel(powerupPendingLevel)},SCREENS.Oi.hs))}function updatePowerup(){if(powerupChoices.length&&(mouseWasPressed(0)&&powerupSelected<0&&handlePowerupTap(mousePosScreen.x,mousePosScreen.y),powerupSelected<0))for(let e=0;e<powerupChoices.length;e++)if(keyWasPressed(49+e))return void selectPowerup(e)}function renderPowerup(){const e=overlayContext,t=stateTime,i=SCREENS.Oi,{va:s,Sa:a,gap:o,ga:n,Ta:r,cx:l,cy:c}=_getCardLayout(),h=clamp(t/.4,0,1);drawRect(vec2(0),vec2(999),new Color(.1,.1,.14)),e.save(),e.font=_F(i.Wi),e.textAlign="center",e.textBaseline="middle",e.letterSpacing=i.Ki,e.fillStyle=`rgba(255,255,255,${h})`,e.fillText("UPGRADE",l,i.Vi),e.restore();for(let l=0;l<powerupChoices.length;l++){const c=powerupChoices[l],u=n+l*(s+o),d=powerupSelected===l,m=l*i.Ji,f=clamp((t-m)/i.qi,0,1),p=(1-f)*i.Zi;e.save(),e.globalAlpha=h*f;const v=mousePosScreen.x,S=mousePosScreen.y,g=v>=u&&v<=u+s&&S>=r+p&&S<=r+p+a;e.fillStyle=d?i.es.toString():g&&powerupSelected<0?i.ts.toString():i.ss.toString(),e.beginPath(),e.roundRect(u,r+p,s,a,i.Ui),e.fill(),e.lineWidth=d?i.ls:i.cs,e.strokeStyle=d?i.ns.toString():i.rs.toString(),e.stroke(),e.restore(),e.save(),e.font=_F(60),e.textAlign="center",e.textBaseline="middle",e.globalAlpha=h*f,e.fillStyle="rgba(130,255,180,1)",e.fillText(c.ic,u+s/2,r+p+80),e.restore(),e.save(),e.font=_F(i.Yi),e.textAlign="center",e.textBaseline="middle",e.globalAlpha=h*f,e.fillStyle="rgba(220,220,220,1)",e.fillText(c.ha,u+s/2,r+p+i.Hi),e.restore(),drawTextScreen(`[${l+1}]`,vec2(u+s/2,r+p+a-i.Qi),i.$i,new Color(.65,.65,.65,h*f*.7))}}function _drawJoystick(e,t,i,s,a,o){e.beginPath(),e.arc(t.x,t.y,INPUT.fi,0,7),e.fillStyle=s.toString(),e.fill(),e.lineWidth=2,e.strokeStyle=a.toString(),e.stroke(),e.beginPath(),e.arc(i.x,i.y,INPUT.fi*INPUT.Si,0,7),e.fillStyle=o.toString(),e.fill()}function renderHud(){const e=overlayContext;if(reloadTimer>0&&player){const t=clamp(1-reloadTimer/getEffectiveReloadTime(),0,1),i=mainCanvasSize.x/1280,s=300*i,a=20*i,o=20*i,n=20*i;e.fillStyle="rgba(255,255,255,0.15)",e.fillRect(o,n,s,a);const r=t<.5?255:Math.round(255*(1-t)),l=t<.5?Math.round(200*t*2):200;e.fillStyle=`rgba(${r},${l},60,0.8)`,e.fillRect(o,n,s*t,a),e.strokeStyle="rgba(255,255,255,0.3)",e.lineWidth=1,e.strokeRect(o,n,s,a),e.save(),e.font=_F(18*i),e.textAlign="left",e.textBaseline="top",e.fillStyle="rgba(255,255,255,0.85)",e.fillText("RELOAD",o,n+a+4*i),e.restore()}if(boss&&!boss.G){const t=HUD.bi,i=clamp(boss.Bt/boss.Vs,0,1),s=t.width,a=t.height,o=(mainCanvasSize.x-s)/2,n=t.y;let r,l,c;if(e.fillStyle="rgba(0,0,0,0.5)",e.fillRect(o-t.padding,n-t.padding,s+2*t.padding,a+2*t.padding),e.fillStyle="rgba(255,255,255,0.1)",e.fillRect(o,n,s,a),i>.5){const e=2*(i-.5);r=Math.round(255*(1-e)),l=200,c=0}else{const e=2*i;r=255,l=Math.round(200*e),c=0}e.fillStyle=`rgba(${r},${l},${c},0.85)`,e.fillRect(o,n,s*i,a)}{let t="";if(t=tutorialPhase>=0?"TUTORIAL":predefinedLevelsBeaten?"INFINITE":boss&&!boss.G?"BOSS FIGHT":"LEVEL "+(currentLevelIndex+1),t){const i=mainCanvasSize.x/1280;e.save(),e.font=_F(36*i),e.textAlign="right",e.textBaseline="top",e.fillStyle="rgba(255,255,255,0.75)",e.fillText(t,mainCanvasSize.x-20*i,20*i),e.restore()}}if(joystickActive&&_drawJoystick(e,joystickOrigin,joystickKnob,INPUT.gi,INPUT.Ti,INPUT.Ci),aimActive&&_drawJoystick(e,aimOrigin,aimKnob,INPUT.yi,INPUT.wi,INPUT.Pi),tutorialPhase>=0){const t=.78*mainCanvasSize.y,i=mainCanvasSize.x/2;let s=TUTORIAL_TEXTS[tutorialPhase],a=tutorialTextAlpha;if(s&&a>0){const o=s.split("\n"),n=o.length>1?34:46,r=1.25*n,l=t-(o.length-1)*r*.5;e.save(),e.font=_F(n),e.textAlign="center",e.textBaseline="middle",e.lineJoin="round";for(let t=0;t<o.length;t++){const s=l+t*r;e.strokeStyle=`rgba(0,0,0,${.85*a})`,e.lineWidth=7,e.strokeText(o[t],i,s),e.fillStyle=`rgba(255,255,255,${a})`,e.fillText(o[t],i,s)}e.restore()}if(0===tutorialPhase&&tutorialMoveTimer>0){const i=clamp(tutorialMoveTimer,0,1),s=180,o=8,n=(mainCanvasSize.x-s)/2,r=t+36;e.fillStyle="rgba(255,255,255,0.15)",e.fillRect(n,r,s,o),e.fillStyle=`rgba(255,255,255,${.7*a})`,e.fillRect(n,r,s*i,o)}if(2===tutorialPhase&&tutorialReady&&tutorialSurviveTimer>0){const i=clamp(tutorialSurviveTimer/2.5,0,1),s=180,a=8,o=(mainCanvasSize.x-s)/2,n=t+36;e.fillStyle="rgba(255,255,255,0.15)",e.fillRect(o,n,s,a),e.fillStyle="rgba(255,255,255,0.7)",e.fillRect(o,n,s*i,a)}}if(screenFlashAlpha>0){const t=clamp(screenFlashAlpha,0,1);e.fillStyle=`rgba(255,255,255,${t})`,e.fillRect(0,0,mainCanvasSize.x,mainCanvasSize.y)}}!function(){const e=["click","touchstart","touchend","keydown"];function t(){audioContext||(audioContext=new(window.AudioContext||webkitAudioContext)),"suspended"===audioContext.state&&audioContext.resume();try{const e=audioContext.createBuffer(1,1,22050),t=audioContext.createBufferSource();t.buffer=e,t.connect(audioContext.destination),t.start()}catch(e){}"running"===audioContext.state&&e.forEach(e=>document.removeEventListener(e,t,!0))}e.forEach(e=>document.addEventListener(e,t,!0))}();let currentLevelData,player,musicVolumeCurrent=.3,levelTiles=vec2(1,1),levelSize=vec2(1,1),currentLevelIndex=0,turrets=[],boss=null,restarting=!1,levelTransitioning=!1,playerIsMoving=!1,predefinedLevelsBeaten=!1,proceduralDifficulty=1,tutorialPhase=-1,tutorialMoveTimer=0,tutorialDodgeCount=0,tutorialShootDisabled=!1,tutorialTextAlpha=0,tutorialReady=!1,tutorialSurviveTimer=0,screenFlashAlpha=0,reloadTimer=0,levelTransitionTimer=new Timer,bulletTrails=[],burstQueue=0,burstTimer=0,burstDir=vec2();function emitShotParticles(e,t,i){const s=PARTICLES.us,a=i??s.offset,o=t&&t.length()>.001?t.normalize():vec2(1,0),n=e.add(o.scale(a));new ParticleEmitter(n,o.angle(),s.Ee,s.Fe,s.Be,s.Le,s.A,s._,s.Ge,s.ke,s.Re,s.je,s.Ae,s._e,s.Xe,s.speed,s.Ne,s.U,s.W,s.Y,s.ds,s.We,s.me,s.q,s.Ve)}function playShotSound(e=1){const t=lerp(clamp(timeScale,.18,1),.65,1);new Sound([2,.03,340,,,.13,1,.5,-7,-19.2,,,.06,,,,.15,.8,.05,,500]).play(void 0,e,t,1)}function playEnemyKillSound(){new Sound([.02,2,277,,.11,.2,1,,.1,,2050,.08,1,,,,.07,2,.03]).play()}function playPlayerDeathSound(){new Sound([.5,0,474,.03,.22,.19,1,.4,,,-181,.11,.03,,,,,.88,.28,,103]).play()}function emitDeathParticles(e){const t=PARTICLES.fs;new ParticleEmitter(e.o(),0,t.Ee,t.Fe,t.Be,t.Le,t.A,t._,t.Ge,t.ke,t.Re,t.je,t.Ae,t._e,t.Xe,t.speed,t.Ne,t.U,t.W,t.Y,t.ds,t.We,t.me,t.q,t.Ve)}let timeScale=1,gameState="intro",stateTime=0;function loadLevel(e){if("object"==typeof e&&null!==e)currentLevelData=parseLevelDefinition(e);else{currentLevelIndex=0|clamp(e,0,LEVEL_DEFINITIONS.length-1),currentLevelData=parseLevelDefinition(LEVEL_DEFINITIONS[currentLevelIndex])}engineObjectsDestroy(),levelTiles=vec2(currentLevelData.width,currentLevelData.height),levelSize=currentLevelData.size.o(),initTileCollision(levelTiles);for(const e of currentLevelData.ys)setTileCollisionData(e,1);player=new Player(currentLevelData.bs),cameraPos=player.j.o(),turrets=currentLevelData.Cs.map(e=>new Turret(e.j)),boss=null,currentLevelData.Ds&&(boss=new Boss(currentLevelData.Ds)),resetInputState(),bulletTrails=[],timeScale=1,reloadTimer=0,burstQueue=0,burstTimer=0,restarting=!1,levelTransitioning=!1,levelTransitionTimer.M()}const TUTORIAL_TEXTS=["Left stick to move","Right stick to aim\nRelease to fire","Time moves only when you move","Destroy Goons"];function loadTutorialStep(e){tutorialPhase=e,tutorialMoveTimer=0,tutorialDodgeCount=0,tutorialShootDisabled=0===e||2===e,tutorialTextAlpha=0,tutorialSurviveTimer=0,screenFlashAlpha=0,tutorialReady=!0;const t=parseLevelDefinition(TUTORIAL_LEVELS[e]);engineObjectsDestroy(),levelTiles=vec2(t.width,t.height),levelSize=t.size.o(),initTileCollision(levelTiles);for(const e of t.ys)setTileCollisionData(e,1);if(player=new Player(t.bs),cameraPos=player.j.o(),turrets=1===e?t.Cs.map(e=>new DummyTurret(e.j)):t.Cs.map(e=>new Turret(e.j)),2===e)for(const e of turrets)e.Xs=null,e.Ns=1/0,e.As=GFX.Dt.It/1.5,e._s=0;boss=null,currentLevelData=t,resetInputState(),bulletTrails=[],timeScale=1,reloadTimer=0,burstQueue=0,burstTimer=0,restarting=!1,levelTransitioning=!1,levelTransitionTimer.M()}function advanceTutorial(){const e=tutorialPhase+1;e<TUTORIAL_LEVELS.length?loadTutorialStep(e):(tutorialPhase=-1,tutorialShootDisabled=!1,powerupPendingLevel=0,preparePowerupChoices(0),gameState="powerup",stateTime=0)}function startGame(){gameState="playing",stateTime=0,resetBuffs(),predefinedLevelsBeaten=!1,proceduralDifficulty=1,loadTutorialStep(0),gameMusic&&gameMusic.play()}async function gameInit(){canvasFixedSize=ENGINE.ei,cameraScale=ENGINE.ti,fontDefault=ENGINE.font,initTouchInput(),gameMusic=new Music(MUSIC_FILE)}function gameUpdate(){if(stateTime+=timeDelta,"intro"===gameState)return void updateIntro();if("title"===gameState)return void updateTitle();if("powerup"===gameState)return void updatePowerup();if(screenFlashAlpha>0&&(screenFlashAlpha=max(0,screenFlashAlpha-3.5*timeDelta)),restarting||!player)return;turrets=turrets.filter(e=>!e.G),tutorialPhase>=0&&tutorialTextAlpha<1&&(tutorialTextAlpha=min(1,tutorialTextAlpha+2*timeDelta));const e=boss&&!boss.G;if(!turrets.length&&!e){if(1===tutorialPhase||3===tutorialPhase)return levelTransitioning||(levelTransitioning=!0,screenFlashAlpha=1,levelTransitionTimer.set(.35)),void(levelTransitionTimer.B()&&advanceTutorial());if(tutorialPhase<0){if(levelTransitioning||(levelTransitioning=!0,screenFlashAlpha=1,levelTransitionTimer.set(GAMEPLAY.ni)),levelTransitionTimer.B()){if(currentLevelIndex===LEVEL_DEFINITIONS.length-1&&(predefinedLevelsBeaten=!0),predefinedLevelsBeaten){const e=generateProceduralLevel(proceduralDifficulty);proceduralDifficulty++,loadLevel(e)}else{const e=currentLevelIndex+1,t=currentLevelIndex+1;t<POWERUP_TIERS.length?(powerupPendingLevel=e,preparePowerupChoices(t),gameState="powerup",stateTime=0):loadLevel(e)}}return}}if(!isTouchDevice&&joystickTouchId<0&&aimTouchId<0&&(mouseWasPressed(0)&&(joystickActive=!0,joystickOrigin=mousePosScreen.o(),joystickKnob=mousePosScreen.o(),joystickDir=vec2(),joystickMag=0),joystickActive&&mouseIsDown(0)&&updateJoystickFromScreenPos(mousePosScreen),mouseWasReleased(0)&&(joystickActive=!1,joystickMag=0)),(keyWasPressed(32)||keyWasPressed(88))&&(shootPressed=!0),joystickMag>0){const e=vec2(joystickDir.x,-joystickDir.y).scale(player.speed*joystickMag),t=GFX.tt.st;player.H=player.H.scale(t).add(e.scale(1-t))}if(aimMag>0){const e=vec2(aimDir.x,-aimDir.y);e.length()>.001&&(player.ot=e)}const t=player.H.length()>GAMEPLAY.ai;if(playerIsMoving=t,timeScale=t?1:getEffectiveSlowScale(),1===tutorialPhase&&(timeScale=1),0===tutorialPhase){if(levelTransitioning)return void(levelTransitionTimer.B()&&advanceTutorial());if(t?tutorialMoveTimer+=timeDelta:tutorialMoveTimer=0,tutorialMoveTimer>=1)return levelTransitioning=!0,screenFlashAlpha=1,void levelTransitionTimer.set(.35)}if(2===tutorialPhase){for(const e of turrets)e.Xs=null,e.Ns=1/0;if(tutorialReady&&(tutorialSurviveTimer+=timeDelta*timeScale,tutorialSurviveTimer>=2.5))return levelTransitioning||(levelTransitioning=!0,screenFlashAlpha=1,levelTransitionTimer.set(.35)),void(levelTransitionTimer.B()&&advanceTutorial())}if(tutorialShootDisabled&&(shootPressed=!1),gameMusic){musicVolumeCurrent=lerp(.05,musicVolumeCurrent,t?.6:.075),gameMusic.ve(musicVolumeCurrent)}reloadTimer>0&&(reloadTimer=max(0,reloadTimer-timeDelta*timeScale)),burstQueue>0&&(burstTimer-=timeDelta*timeScale,burstTimer<=0&&(burstTimer=SHOOTING.ci,burstQueue--,firePlayerBullet(player.Es,burstDir),playShotSound()));if(shootPressed&&(reloadTimer<=0&&burstQueue<=0)){reloadTimer=getEffectiveReloadTime();const e=player.ot.length()?player.ot:vec2(1,0),t=player.Es;if(activeBuffs.fa){const i=SHOOTING.ri;[e,e.rotate(i),e.rotate(-i)].forEach(e=>firePlayerBullet(t,e)),playShotSound()}else activeBuffs.pa?(firePlayerBullet(t,e),playShotSound(),burstDir=e,burstQueue=SHOOTING.li-1,burstTimer=SHOOTING.ci):(firePlayerBullet(t,e),playShotSound())}shootPressed=!1}function gameUpdatePost(){if("playing"!==gameState||!player)return;const e=GAMEPLAY.oi,t=player.j;cameraPos=cameraPos.add(t.l(cameraPos).scale(e));const i=mainCanvasSize.x/cameraScale*.5,s=mainCanvasSize.y/cameraScale*.5;levelSize.x<=2*i?cameraPos.x=.5*levelSize.x:cameraPos.x=clamp(cameraPos.x,i,levelSize.x-i),levelSize.y<=2*s?cameraPos.y=.5*levelSize.y:cameraPos.y=clamp(cameraPos.y,s,levelSize.y-s)}function gameRender(){if("playing"!==gameState)return;const e=currentLevelData.ws;for(let t=0;t<levelTiles.x;t++)for(let i=0;i<levelTiles.y;i++)drawTile(vec2(t+.5,i+.5),vec2(1),e[t][i]+8,vec2(16));if(player&&0!==tutorialPhase&&2!==tutorialPhase){const e=GFX.tt.ot,t=player.Ms,i=player.Es;let s=0;for(;s<e.lt;){const a=i.add(t.scale(s)),o=i.add(t.scale(Math.min(s+e.nt,e.lt))),n=1-s/e.lt;drawLine(a,o,e.width,GFX.tt.color.scale(1,n*e.alpha)),s+=e.nt+e.rt}}if(!player)return;for(const e of turrets){const t=player.j.l(e.j);t.length()<=.001||drawLine(e.j,e.j.add(t.normalize(GFX.Dt.xt)),GFX.Dt.zt)}const t=GFX.ft.St.width,i=GFX.ft.St.Tt;for(let e=bulletTrails.length-1;e>=0;e--){const s=bulletTrails[e];let a=!1;for(let e=1;e<s.points.length;e++){const i=s.points[e-1],o=s.points[e];o.alpha<=0||(a=!0,drawLine(i.j,o.j,t,s.color.scale(1,o.alpha)))}for(const e of s.points)e.alpha-=timeDelta*i;a||bulletTrails.splice(e,1)}}function gameRenderPost(){"intro"!==gameState?"title"!==gameState?"powerup"!==gameState?renderHud():renderPowerup():renderTitle():renderIntro()}engineInit(gameInit,gameUpdate,gameUpdatePost,gameRender,gameRenderPost,"t.png");